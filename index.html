<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Civil Engineering – Scaling & Proportion Worksheet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    :root{
      --accent:#6a5cff;         /* vibrant indigo */
      --accent2:#00c2ff;        /* aqua */
      --light:#eef3ff;
      --ink:#0f172a;
      --muted:#55607a;
      --success:#2e7d32;
      --error:#e53935;
      --surface:#ffffff;
      --field-w:11rem;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      margin:0;color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, #dfe8ff, transparent 60%),
        radial-gradient(1200px 600px at 110% 10%, #ccfbff, transparent 60%),
        linear-gradient(180deg,#f5f8ff 0%, #f0fbff 50%, #eef3ff 100%);
    }
    h1{
      margin:0.7rem 0 0.4rem;text-align:center;
      font-size:1.6rem;font-weight:900;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text;background-clip:text;color:transparent;
      letter-spacing:.2px
    }
    p.lede{max-width:980px;margin:0.2rem auto 0.6rem;text-align:center;color:#1f2a44}

    .logo{position:absolute;top:10px;left:10px;width:110px;height:auto;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.15)}

    /* Top bar */
    .topbar{
      max-width:980px;margin:0.15rem auto 0.65rem;display:flex;gap:0.6rem;
      justify-content:space-between;align-items:center;padding:0 0.6rem
    }
    .badge{
      background:#fff;border:1px solid rgba(106,92,255,.25);border-radius:14px;
      padding:0.5rem 0.7rem;font-weight:800;min-width:120px;text-align:center;
      box-shadow:0 3px 10px rgba(106,92,255,.08)
    }
    .badge small{display:block;font-weight:600;color:var(--muted);margin-top:2px;font-size:.82rem}
    .top-actions{display:flex;gap:0.45rem;align-items:center}
    .fsBtn{
      border:1px solid rgba(0,194,255,.5);background:linear-gradient(180deg,#ffffff,#f3fcff);
      border-radius:12px;padding:.55rem .8rem;font-weight:900;cursor:pointer;color:#0b3d4a;
      box-shadow:0 3px 10px rgba(0,194,255,.15)
    }
    .fsBtn:hover{background:#ecfbff}

    /* Card */
    .card{
      max-width:980px;margin:0.25rem auto;background:var(--surface);border-radius:16px;
      border:2px solid rgba(106,92,255,.35);
      box-shadow:0 12px 30px rgba(106,92,255,.12), 0 6px 14px rgba(0,0,0,.06);
      padding:0.95rem
    }
    .titleRow{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem}
    .qTitle{font-size:1.15rem;font-weight:900;color:#2c3477;margin:0.1rem 0}
    .qMeta{color:var(--muted);font-size:.95rem}

    .statement{font-size:1rem;margin:0.55rem 0 0.7rem}
    details{border:1px solid rgba(106,92,255,.3);border-radius:12px;margin:0.5rem 0;background:#fbfcff}
    summary{cursor:pointer;font-weight:900;color:#2c3477;padding:0.6rem 0.8rem;list-style:none}
    summary::-webkit-details-marker{display:none}
    .hint{padding:0 0.9rem 0.85rem;font-size:.95rem;color:#1f2a44}
    .hint ul{margin:0.35rem 0 0.25rem 1.2rem}
    .hint code{background:#f1f4ff;padding:2px 6px;border-radius:6px;border:1px solid rgba(106,92,255,.25)}
    .hint strong{color:#1a2b7a}

    /* Inputs */
    .io{display:grid;gap:0.8rem;margin-top:0.5rem}
    .row{display:grid;grid-template-columns:1.2fr auto auto auto 1fr;align-items:center;gap:.5rem}
    .row label{font-weight:900;color:#1f2a44}
    .unit{
      background:linear-gradient(180deg,#eef4ff,#f7fbff);
      border:1px solid rgba(0,194,255,.35);
      color:#173a56;border-radius:10px;padding:0.35rem 0.6rem;font-weight:900;min-width:6.5rem;text-align:center
    }
    .num{
      width:var(--field-w);text-align:center;border:1px solid rgba(106,92,255,.45);
      border-radius:10px;font-size:1.02rem;padding:.48rem .4rem;background:linear-gradient(180deg,#ffffff,#f6f7ff);
      box-shadow:inset 0 1px 2px rgba(0,0,0,.06)
    }
    .num:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(106,92,255,.18)}

    /* Markers & feedback */
    .marker{font-size:1.45rem;font-weight:900;min-width:1.9rem;text-align:center}
    .ok{color:var(--success); animation:pop .25s ease-out}
    .no{color:var(--error)}
    @keyframes pop { 0%{transform:scale(0.85)} 100%{transform:scale(1)} }
    .feedback{font-size:0.95rem;color:#1f2a44}
    .feedback .ans{font-weight:900}

    /* Controls */
    .controls{display:flex;justify-content:center;gap:.6rem;margin-top:0.75rem;flex-wrap:wrap}
    button.primary{
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      color:#fff;border:none;border-radius:12px;padding:.7rem 1.2rem;font-weight:900;cursor:pointer;
      box-shadow:0 8px 18px rgba(106,92,255,.25)
    }
    button.secondary{
      background:#111827;color:#fff;border:none;border-radius:12px;padding:.7rem 1.2rem;font-weight:900;cursor:pointer
    }
    button.ghost{
      background:linear-gradient(180deg,#ffffff,#f7f9ff);border:1px solid rgba(17,24,39,.25);
      border-radius:12px;padding:.6rem 1rem;font-weight:900;cursor:pointer;color:#111827
    }
    button:disabled{opacity:.6;cursor:not-allowed}
    #progress{font-weight:900;text-align:center;color:#111827;margin:0.15rem 0 0.6rem}

    /* Start modal */
    .modal{position:fixed;inset:0;background:rgba(15,23,42,.35);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:999}
    .panel{
      background:linear-gradient(180deg,#ffffff,#f7f8ff);
      border-radius:16px;max-width:780px;width:100%;
      box-shadow:0 18px 40px rgba(17,24,39,.25);border:2px solid rgba(106,92,255,.35)
    }
    .panel header{padding:0.9rem 1rem;border-bottom:1px solid rgba(106,92,255,.25)}
    .panel header h2{margin:0;color:#2c3477}
    .panel .content{padding:1rem;display:grid;gap:0.9rem}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:0.8rem}
    .field{display:grid;gap:0.35rem}
    .field input[type=text], .field input[type=number], .field select{
      padding:0.55rem .6rem;border:1px solid rgba(106,92,255,.4);border-radius:10px;background:#fff
    }
    .choiceRow{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid rgba(106,92,255,.45);padding:.35rem .7rem;border-radius:999px;cursor:pointer;font-weight:900;background:#fff}
    .pill input{margin-right:.35rem}
    .panel footer{display:flex;justify-content:space-between;align-items:center;padding:0.85rem 1rem;border-top:1px solid rgba(106,92,255,.25)}
    .muted{color:var(--muted);font-size:.95rem}

    /* End screen */
    #endCard{max-width:820px;margin:1rem auto;padding:1rem;border-radius:14px;background:#fff;border:2px solid #2e7d32;display:none}
    #endCard h3{margin-top:0;color:#1e7a31}
    .wellDone{display:inline-block;background:#eaf7ec;border:1px solid #b9e2bf;color:#1e7a31;padding:.25rem .5rem;border-radius:8px;font-weight:900}

    /* Small screens / short viewports */
    @media (max-width:680px){
      .row{grid-template-columns:1fr auto auto auto 1fr}
      .grid2{grid-template-columns:1fr}
      .num{width:8.8rem}
      .logo{width:88px}
    }
    @media (max-height:740px){
      body{font-size:0.97rem}
      .qTitle{font-size:1.07rem}
      .num{padding:.38rem .34rem}
      .card{padding:0.8rem}
      .topbar{gap:0.45rem}
      .badge{padding:0.4rem 0.6rem}
    }
  </style>
</head>
<body>
  <img src="https://lirp.cdn-website.com/b085c470/dms3rep/multi/opt/Bucks%2BCollege%2BGroup-e5af1b68-1920w.jpg"
       alt="Bucks College Group logo" class="logo">

  <h1>Scaling &amp; Proportion – Civil Engineering</h1>
  <p class="lede">Use ratios and proportions (direct &amp; inverse) to solve site &amp; design problems. <strong>Enter answers to 2 decimal places.</strong></p>

  <div class="topbar">
    <div style="display:flex;gap:0.6rem;align-items:center">
      <div class="badge" id="who"><span id="whoName">Student</span><small>Participant</small></div>
      <div class="badge" id="mode"><span id="modeTxt">Timed</span><small>Mode</small></div>
      <div class="badge" id="timer"><span id="timeTxt">—</span><small>Timer</small></div>
      <div class="badge" id="scoreTop"><span id="scoreTopVal">0 / 0</span><small>Score</small></div>
    </div>
    <div class="top-actions">
      <button class="fsBtn" id="fsBtn" title="Toggle full screen">⛶ Full screen</button>
    </div>
  </div>

  <!-- Global how-to hint -->
  <div class="card" id="globalHint">
    <details>
      <summary>Quick refresher (click to expand)</summary>
      <div class="hint">
        <ul>
          <li><strong>Direct proportion:</strong> \(y \propto x\Rightarrow \dfrac{y_2}{y_1}=\dfrac{x_2}{x_1}\).</li>
          <li><strong>Inverse proportion:</strong> \(y \propto \dfrac{1}{x}\Rightarrow \dfrac{y_2}{y_1}=\dfrac{x_1}{x_2}\).</li>
          <li><strong>Ratios &amp; fractions:</strong> A \(1:2:4\) mix means parts out of the total \(1+2+4=7\).</li>
          <li><strong>Scale drawings:</strong> \( \text{drawing}:\text{real} = 1:s\). Lengths scale by \(1/s\); areas by \(1/s^2\).</li>
          <li><strong>Round every final answer to 2 dp.</strong></li>
        </ul>
      </div>
    </details>
  </div>

  <!-- Question card -->
  <div class="card" id="qCard" style="display:none">
    <div class="titleRow">
      <div>
        <div class="qTitle" id="qTitle">Question</div>
        <div class="qMeta" id="qMeta">Use the stated proportion/scale. Answer to <strong>2 dp</strong>, then click <strong>Check</strong>.</div>
      </div>
      <div class="qMeta" id="progress">Question 1</div>
    </div>

    <div class="statement" id="statement"></div>

    <details id="hintBox">
      <summary>Hint / Formula (click to expand)</summary>
      <div class="hint" id="hintHtml"></div>
    </details>

    <div class="io">
      <div class="row">
        <label>Result</label>
        <input class="num" id="ansVal" type="text" inputmode="decimal" autocomplete="off" placeholder="e.g. 123.45">
        <span class="unit" id="unitOut"></span>
        <span class="marker" id="markAns"></span>
        <span class="feedback" id="fbAns"></span>
      </div>
    </div>

    <div class="controls">
      <button class="primary" id="checkBtn">Check</button>
      <button class="ghost" id="nextBtn" disabled>Next</button>
      <button class="secondary" id="newBtn">New questions</button>
    </div>
  </div>

  <!-- End summary -->
  <div id="endCard">
    <h3>Summary</h3>
    <p class="wellDone" id="endMsg"></p>
    <ul>
      <li><strong>Name:</strong> <span id="sumName"></span></li>
      <li><strong>Mode:</strong> <span id="sumMode"></span></li>
      <li><strong>Score:</strong> <span id="sumScore"></span></li>
      <li><strong>Time used:</strong> <span id="sumTime"></span></li>
    </ul>
    <div style="display:flex;gap:.6rem;justify-content:center;margin-top:.4rem">
      <button class="secondary" id="restartBtn">Restart</button>
    </div>
  </div>

  <!-- Start menu modal -->
  <div class="modal" id="startModal">
    <div class="panel">
      <header><h2>Start Worksheet</h2></header>
      <div class="content">
        <div class="field">
          <label for="nameInput"><strong>Your name</strong></label>
          <input id="nameInput" type="text" placeholder="Type your name…" autocomplete="name">
        </div>

        <div class="field">
          <label><strong>Mode</strong></label>
          <div class="choiceRow">
            <label class="pill"><input type="radio" name="mode" value="timed" checked>Timed</label>
            <label class="pill"><input type="radio" name="mode" value="target">Target</label>
          </div>
        </div>

        <div class="grid2">
          <div class="field" id="timedField" style="display:block">
            <label><strong>Time limit</strong></label>
            <div class="choiceRow">
              <label class="pill"><input type="radio" name="tlimit" value="600">10 minutes</label>
              <label class="pill"><input type="radio" name="tlimit" value="1200" checked>20 minutes</label>
              <label class="pill"><input type="radio" name="tlimit" value="1800">30 minutes</label>
              <label class="pill"><input type="radio" name="tlimit" value="0">Unlimited</label>
            </div>
          </div>

          <div class="field" id="targetField" style="display:none">
            <label for="targetInput"><strong>Target (correct answers to finish)</strong></label>
            <input id="targetInput" type="number" min="1" max="1000" step="1" value="8">
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label for="qtyInput"><strong>Total questions (per set)</strong></label>
            <select id="qtyInput">
              <option value="8">8</option>
              <option value="10" selected>10</option>
              <option value="12">12</option>
              <option value="15">15</option>
            </select>
          </div>
          <div class="field">
            <label class="muted">Tip</label>
            <div class="muted">For inverse proportion, swap the ratio; for scale drawings, scale lengths by \(1:s\) and areas by \(1:s^2\). Answer to <strong>2 dp</strong>.</div>
          </div>
        </div>
      </div>
      <footer>
        <span class="muted">You can generate a fresh random set any time.</span>
        <div>
          <button class="primary" id="startBtn">Start worksheet</button>
        </div>
      </footer>
    </div>
  </div>

<script>
/* ========= Core helpers ========= */
const rnd=(m,M)=>Math.floor(Math.random()*(M-m+1))+m;
const pick=arr=>arr[Math.floor(Math.random()*arr.length)];
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

const round2=x=>Math.round((+x + Number.EPSILON)*100)/100;
const to2=x=>isFinite(x)?round2(x).toFixed(2):'—';
const parseNum = (input) => {
  const raw = (typeof input === 'string' ? input : (input?.value ?? '')).toString().trim().replace(',','.');
  const x = parseFloat(raw);
  return isFinite(x)?x:NaN;
};
const eq2dp=(a,b)=>isFinite(a)&&isFinite(b)&&round2(a)===round2(b);
const secsToMMSS=s=>{const m=Math.floor(s/60), ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`;};

/* ========= Unit helpers ========= */
const unit = (u) => ({
  mm:'mm', cm:'cm', m:'m', in:'in',
  mm2:'mm²', cm2:'cm²', m2:'m²',
  N:'N', kN:'kN', MPa:'MPa', L:'L',
  'km/h':'km/h', 'min':'min', 'h':'h', 'days':'days', 't':'t'
}[u]||u);

/* ========= Question generators =========
 Each returns {title, statementHTML, hintHTML, unitOut, check:()=>({val})}
 The check() returns the numeric expected value (unrounded).
*/

/* --- Scale drawings & areas --- */
function qScale_Draw_mm(){
  const s = pick([20,50,100,200,250,500]);
  const Lm = +(rnd(2,60) + Math.random()).toFixed(2); // m with decimals
  const Ldraw_mm = (Lm * 1000) / s;
  return {
    title:'Plan length from scale (m → mm)',
    statementHTML:`A retaining wall segment is <strong>${Lm.toFixed(2)} m</strong> long in reality. On a plan at <strong>1:${s}</strong>, what is its length on the drawing (in mm)?`,
    hintHTML:`Direct proportion with a scale: \\( \\dfrac{L_{draw}}{L_{real}}=\\dfrac{1}{${s}} \\Rightarrow L_{draw}=\\dfrac{L_{real}}{${s}}\\). Convert m→mm by \\(\\times 1000\\).`,
    unitOut: unit('mm'),
    check:()=>({ val: Ldraw_mm })
  };
}
function qScale_Actual_m(){
  const s = pick([50,100,200,500]);
  const mm = rnd(30, 360) + Math.random();
  const Lm = (mm * s) / 1000;
  return {
    title:'Actual length from plan (mm → m)',
    statementHTML:`A site boundary measures <strong>${mm.toFixed(2)} mm</strong> on a drawing at <strong>1:${s}</strong>. Estimate the actual length (m).`,
    hintHTML:`\\( \\dfrac{L_{draw}}{L_{real}}=\\dfrac{1}{${s}} \\Rightarrow L_{real}=${s}\\,L_{draw}.\\) Convert mm→m by \\(/1000\\).`,
    unitOut: unit('m'),
    check:()=>({ val: Lm })
  };
}
function qScale_Area_m2(){
  const s = pick([100,200,250,500]);
  const a = rnd(30,150); // mm
  const b = rnd(30,150); // mm
  const L1 = (a*s)/1000; // m
  const L2 = (b*s)/1000; // m
  const A = L1*L2;
  return {
    title:'Plan area from scale (mm @ 1:s → m²)',
    statementHTML:`On a plan at <strong>1:${s}</strong>, a rectangular car‑park bay measures <strong>${a} mm × ${b} mm</strong>. Estimate its actual area (m²).`,
    hintHTML:`Lengths scale by \\(${1}/${s}\\), so areas scale by \\(1/${s}^2\\). Compute \\(A=(a\\cdot ${s}/1000)\\times(b\\cdot ${s}/1000)\\).`,
    unitOut: unit('m2'),
    check:()=>({ val: A })
  };
}

/* --- Ratios & fractions --- */
function qMix_124_Cement(){
  const V = +(rnd(4, 40) + Math.random()).toFixed(2); // m³
  const cement = V * (1/7);
  return {
    title:'Concrete mix 1:2:4 (cement volume)',
    statementHTML:`For a pour of <strong>${V.toFixed(2)} m³</strong> concrete with a <strong>1:2:4</strong> mix by volume, estimate the volume of <strong>cement</strong> required (m³).`,
    hintHTML:`In a \\(1:2:4\\) mix, cement fraction = \\(\\tfrac{1}{1+2+4}=\\tfrac{1}{7}\\). Multiply total volume by \\(1/7\\).`,
    unitOut: unit('m'),
    check:()=>({ val: cement })
  };
}
function qAsphalt_Binder(){
  const total_t = +(rnd(40, 250) + Math.random()).toFixed(2); // tonnes
  const binder = total_t * 0.05;
  return {
    title:'Asphalt binder proportion (mass %)',
    statementHTML:`A batch totals <strong>${total_t.toFixed(2)} t</strong> of asphalt. Binder content is <strong>5%</strong> by mass. Estimate the binder mass (t).`,
    hintHTML:`Direct proportion: binder mass = \\(0.05\\times\\) total mass.`,
    unitOut: 't',
    check:()=>({ val: binder })
  };
}

/* --- Inverse proportion basics --- */
function qWorkers_Time(){
  const n1 = rnd(4,10);
  const t1 = +(rnd(3,10) + Math.random()).toFixed(2); // days
  const n2 = rnd(n1+1, n1+8);
  const t2 = t1 * (n1/n2);
  return {
    title:'Excavation crew time (inverse proportion)',
    statementHTML:`A trenching crew of <strong>${n1}</strong> workers completes a section in <strong>${t1.toFixed(2)} days</strong>. With <strong>${n2}</strong> workers at the same productivity, estimate the time (days).`,
    hintHTML:`Time \\(\\propto \\tfrac{1}{\\text{workers}}\\): \\(t_2=t_1\\cdot\\dfrac{n_1}{n_2}\\).`,
    unitOut: unit('days'),
    check:()=>({ val: t2 })
  };
}
function qPump_Time_min(){
  const V = +(rnd(8, 60) + Math.random()).toFixed(2);  // m³
  const q = +(rnd(10, 180) + Math.random()).toFixed(2); // L/s
  const t_min = (V*1000)/q/60;
  return {
    title:'Dewatering tank time (inverse proportion)',
    statementHTML:`A sump holds <strong>${V.toFixed(2)} m³</strong> of water. A pump discharges at <strong>${q.toFixed(2)} L/s</strong>. Estimate the time to empty (minutes).`,
    hintHTML:`\\(t=\\dfrac{\\text{volume}}{\\text{rate}}\\). Convert m³→L by \\(\\times 1000\\); seconds→minutes by \\(/60\\).`,
    unitOut: unit('min'),
    check:()=>({ val: t_min })
  };
}
function qTravel_Time_change(){
  const v1 = +(rnd(12, 32) + Math.random()).toFixed(2); // km/h
  const v2 = +(rnd(20, 45) + Math.random()).toFixed(2); // km/h
  const D  = +(rnd(3, 20) + Math.random()).toFixed(2);  // km
  const t1 = D / v1; // h
  const t2 = t1 * (v1 / v2); // h
  return {
    title:'Crawler move time (inverse proportion)',
    statementHTML:`A crawler travelled a pad‑to‑pad distance at <strong>${v1.toFixed(2)} km/h</strong> taking <strong>${(t1).toFixed(2)} h</strong>. Under better conditions, average speed rises to <strong>${v2.toFixed(2)} km/h</strong>. Estimate the new time (h).`,
    hintHTML:`For fixed distance, \\(t\\propto 1/v\\Rightarrow t_2 = t_1\\cdot\\dfrac{v_1}{v_2}\\).`,
    unitOut: unit('h'),
    check:()=>({ val: t2 })
  };
}

/* --- Direct proportion --- */
function qVolume_Thickness(){
  const V1 = +(rnd(4, 25) + Math.random()).toFixed(2); // m³
  const t1 = +(rnd(150, 300) + Math.random()).toFixed(2); // mm
  const t2 = +(rnd(180, 400) + Math.random()).toFixed(2); // mm
  const V2 = V1 * (t2 / t1);
  return {
    title:'Slab volume vs thickness (direct proportion)',
    statementHTML:`A slab pour used <strong>${V1.toFixed(2)} m³</strong> at thickness <strong>${t1.toFixed(2)} mm</strong>. If the thickness changes to <strong>${t2.toFixed(2)} mm</strong> over the same area, estimate the new volume (m³).`,
    hintHTML:`For fixed area, \\(V\\propto t\\): \\(V_2=V_1\\cdot \\tfrac{t_2}{t_1}\\). Units cancel in the ratio.`,
    unitOut: unit('m'),
    check:()=>({ val: V2 })
  };
}
function qProps_Capacity(){
  const P1 = +(rnd(30, 120) + Math.random()).toFixed(2); // kN total with n1 props
  const n1 = rnd(3,8);
  const n2 = rnd(n1+1, n1+7);
  const P2 = P1 * (n2 / n1);
  return {
    title:'Formwork props vs total capacity (direct proportion)',
    statementHTML:`A deck is shored with <strong>${n1}</strong> props sharing a total capacity of <strong>${P1.toFixed(2)} kN</strong>. If the number of props increases to <strong>${n2}</strong>, estimate the total capacity (kN) assuming equal sharing and identical props.`,
    hintHTML:`Direct proportion: \\(P_2 = P_1\\cdot\\dfrac{n_2}{n_1}\\).`,
    unitOut: 'kN',
    check:()=>({ val: P2 })
  };
}
function qWindPressure(){
  const v1 = +(rnd(10, 18) + Math.random()).toFixed(2); // m/s
  const p1 = +(rnd(0.3, 0.9) + Math.random()).toFixed(2); // kPa
  const v2 = +(rnd(15, 28) + Math.random()).toFixed(2); // m/s
  const p2 = p1 * Math.pow(v2/v1, 2);
  return {
    title:'Cladding wind pressure scaling (p ∝ v²)',
    statementHTML:`At wind speed <strong>${v1.toFixed(2)} m/s</strong>, façade pressure is <strong>${p1.toFixed(2)} kPa</strong>. Estimate the pressure at <strong>${v2.toFixed(2)} m/s</strong>.`,
    hintHTML:`\\(\\dfrac{p_2}{p_1}=\\left(\\dfrac{v_2}{v_1}\\right)^2\\Rightarrow p_2=p_1\\left(\\dfrac{v_2}{v_1}\\right)^2\\).`,
    unitOut: 'kPa',
    check:()=>({ val: p2 })
  };
}

/* --- Inverse from stress (needs unit conversion) --- */
function qStress_ReqArea(){
  const FkN = +(rnd(120, 900) + Math.random()).toFixed(2);
  const sig = +(rnd(120, 260) + Math.random()).toFixed(2); // MPa = N/mm²
  const A = (FkN*1000)/sig; // mm²
  return {
    title:'Required steel area (inverse proportion)',
    statementHTML:`A tie must carry <strong>${FkN.toFixed(2)} kN</strong> at an allowable stress of <strong>${sig.toFixed(2)} MPa</strong>. Estimate the required cross‑sectional area (mm²).`,
    hintHTML:`\\(\\sigma=\\tfrac{F}{A}\\Rightarrow A=\\dfrac{F}{\\sigma}\\). Convert kN→N by \\(\\times 1000\\); MPa= N/mm².`,
    unitOut: unit('mm2'),
    check:()=>({ val: A })
  };
}

/* --- NEW: Multi‑factor proportion (machines–time–output) --- */
/* Generic relationship: Q = r * M * T (constant r),
   so  T₂ = T₁ * (Q₂/Q₁) * (M₁/M₂) */
function qProd_Mixers(){
  const M1 = rnd(3,8),  T1 = +(rnd(4,10) + Math.random()).toFixed(2);   // h
  const Q1 = +(rnd(60,180) + Math.random()).toFixed(2);                  // m³ concrete
  const M2 = rnd(Math.max(1, M1-2), M1+3);
  const Q2 = +(Q1 * (0.8 + Math.random()*1.8)).toFixed(2);               // 0.8..2.6 × Q1
  const T2 = T1 * (Q2/Q1) * (M1/M2);
  return {
    title:'Batching plant output (mixers–time–volume)',
    statementHTML:`A batching setup with <strong>${M1}</strong> mixers produces <strong>${Q1.toFixed(2)} m³</strong> of concrete in <strong>${T1.toFixed(2)} h</strong>.
      How long would it take <strong>${M2}</strong> mixers to produce <strong>${Q2.toFixed(2)} m³</strong> (same productivity per mixer)?`,
    hintHTML:`Production \\(Q=rMT\\). Hence \\(T_2 = T_1\\cdot\\dfrac{Q_2}{Q_1}\\cdot\\dfrac{M_1}{M_2}\\).`,
    unitOut: unit('h'),
    check:()=>({ val: T2 })
  };
}
function qProd_Pavers(){
  const P1 = rnd(1,4),  T1 = +(rnd(4,12) + Math.random()).toFixed(2); // h
  const A1 = +(rnd(600, 2200) + Math.random()).toFixed(2);            // m² asphalt
  const P2 = rnd(Math.max(1, P1-1), P1+3);
  const A2 = +(A1 * (0.7 + Math.random()*2.0)).toFixed(2);            // 0.7..2.7 ×
  const T2 = T1 * (A2/A1) * (P1/P2);
  return {
    title:'Asphalt paving (pavers–time–area)',
    statementHTML:`With <strong>${P1}</strong> paver(s), a crew lays <strong>${A1.toFixed(2)} m²</strong> in <strong>${T1.toFixed(2)} h</strong>.
      How long for <strong>${P2}</strong> paver(s) to lay <strong>${A2.toFixed(2)} m²</strong> at the same per‑paver productivity?`,
    hintHTML:`Area \\(A=rMT\\) ⇒ \\(T_2 = T_1\\cdot\\dfrac{A_2}{A_1}\\cdot\\dfrac{P_1}{P_2}\\).`,
    unitOut: unit('h'),
    check:()=>({ val: T2 })
  };
}
function qProd_Excavators(){
  const E1 = rnd(2,6),  T1 = +(rnd(4,10) + Math.random()).toFixed(2); // h
  const V1 = +(rnd(800, 6000) + Math.random()).toFixed(2);            // m³ earth
  const E2 = rnd(Math.max(1, E1-1), E1+4);
  const V2 = +(V1 * (0.6 + Math.random()*2.4)).toFixed(2);            // 0.6..3.0 ×
  const T2 = T1 * (V2/V1) * (E1/E2);
  return {
    title:'Bulk excavation (excavators–time–volume)',
    statementHTML:`A team with <strong>${E1}</strong> excavator(s) removes <strong>${V1.toFixed(2)} m³</strong> in <strong>${T1.toFixed(2)} h</strong>.
      How long would <strong>${E2}</strong> excavator(s) take to remove <strong>${V2.toFixed(2)} m³</strong> at the same per‑machine productivity?`,
    hintHTML:`Volume \\(V=rMT\\) ⇒ \\(T_2 = T_1\\cdot\\dfrac{V_2}{V_1}\\cdot\\dfrac{E_1}{E_2}\\).`,
    unitOut: unit('h'),
    check:()=>({ val: T2 })
  };
}

/* Pool of generators (randomised each set) */
const GENERATORS = [
  // Scale & area
  qScale_Draw_mm, qScale_Actual_m, qScale_Area_m2,
  // Ratios
  qMix_124_Cement, qAsphalt_Binder,
  // Inverse basics
  qWorkers_Time, qPump_Time_min, qTravel_Time_change,
  // Direct & power-law
  qVolume_Thickness, qProps_Capacity, qWindPressure,
  // Inverse with units
  qStress_ReqArea,
  // NEW multi‑factor proportion
  qProd_Mixers, qProd_Pavers, qProd_Excavators
];

/* ========= State ========= */
let QUESTIONS=[], BATCH=10, idx=0, score=0; // idx = total questions served so far
let nameStr='Student', mode='timed', timeLeft=0, timerId=null, target=0, correctSoFar=0, unlimited=false;
let currentQ=null;

/* ========= Elements ========= */
const el = id=>document.getElementById(id);
const $startModal=el('startModal');
const $qCard=el('qCard');
const $endCard=el('endCard');
const $who=el('whoName'), $mode=el('modeTxt'), $timer=el('timeTxt'), $scoreTop=el('scoreTopVal');
const $qTitle=el('qTitle'), $qMeta=el('qMeta'), $statement=el('statement'), $hintHtml=el('hintHtml');
const $progress=el('progress');
const $ansVal=el('ansVal'), $unitOut=el('unitOut'), $markAns=el('markAns'), $fbAns=el('fbAns');
const $checkBtn=el('checkBtn'), $nextBtn=el('nextBtn'), $newBtn=el('newBtn'), $fsBtn=el('fsBtn');
/* End summary */
const $endMsg=el('endMsg'), $sumName=el('sumName'), $sumMode=el('sumMode'), $sumScore=el('sumScore'), $sumTime=el('sumTime');

/* ========= Build a set ========= */
function buildSet(n){
  const gens=[...GENERATORS];
  const qs=[];
  for(let i=0;i<n;i++){
    const g = gens.length ? gens.splice(rnd(0,gens.length-1),1)[0] : pick(GENERATORS);
    qs.push(g());
  }
  return qs;
}

/* ========= Top bar / timer ========= */
function updateTop(){
  $who.textContent = nameStr || 'Student';
  $mode.textContent = mode==='timed' ? 'Timed' : 'Target';
  $scoreTop.textContent = `${score} / ${idx}`;
  $timer.textContent = (mode==='timed' && !unlimited) ? secsToMMSS(timeLeft) : '—';
}
function startTimer(){
  if(mode!=='timed' || unlimited) return;
  clearInterval(timerId);
  timerId = setInterval(()=>{
    timeLeft = Math.max(0, timeLeft-1);
    $timer.textContent = secsToMMSS(timeLeft);
    if(timeLeft===0){
      clearInterval(timerId);
      finish('Time’s up!');
    }
  },1000);
}

/* ========= Start / Finish ========= */
function startWorksheet(){
  BATCH = parseInt(el('qtyInput').value,10);
  QUESTIONS = buildSet(BATCH);
  idx=0; score=0; correctSoFar=0;
  $endCard.style.display='none';
  $qCard.style.display='block';
  el('globalHint').style.display='block';
  renderQ();
  updateTop();
  if(window.MathJax){ MathJax.typeset(); }
  if(mode==='timed'){ startTimer(); }
}
function finish(message='Well done!'){
  clearInterval(timerId);
  $qCard.style.display='none';
  el('globalHint').style.display='none';
  $endCard.style.display='block';
  $endMsg.textContent = message;
  $sumName.textContent = nameStr || 'Student';
  $sumMode.textContent = ($mode.textContent);
  $sumScore.textContent = `${score} / ${idx}`;
  const tlimitRaw = parseInt(document.querySelector('input[name="tlimit"]:checked')?.value||'0',10);
  const setTime = (mode==='timed' && !unlimited) ? tlimitRaw : 0;
  const usedSecs = (mode==='timed' && !unlimited) ? (setTime - timeLeft) : 0;
  $sumTime.textContent = (mode==='timed' && !unlimited) ? secsToMMSS(usedSecs) : '—';
}

/* ========= Render ========= */
function clearFeedback(){
  $markAns.textContent=''; $markAns.className='marker'; $fbAns.textContent='';
}
function progressText(){
  return (mode==='timed') ? `Question ${idx+1}` : `Question ${idx+1} · Target ${correctSoFar}/${target}`;
}
function renderQ(){
  const local = idx % QUESTIONS.length;
  currentQ = QUESTIONS[local];
  $progress.textContent = progressText();
  $qTitle.textContent = currentQ.title;
  $statement.innerHTML = currentQ.statementHTML;
  $hintHtml.innerHTML = currentQ.hintHTML;
  $unitOut.textContent = currentQ.unitOut;
  $ansVal.value='';
  $ansVal.disabled=false;
  clearFeedback();
  $nextBtn.disabled = true;
  if(window.MathJax){ MathJax.typeset(); }
}

/* ========= Check/Score ========= */
function checkCurrent(){
  const { val } = currentQ.check();
  const expected = round2(val);
  const expectedStr = to2(expected);
  const stu = parseNum($ansVal);

  if(isFinite(stu)) $ansVal.value = to2(stu);

  let ok=false;
  if(isFinite(stu) && eq2dp(stu, expected)){
    $markAns.textContent='✓'; $markAns.className='marker ok'; $fbAns.textContent='';
    ok=true;
  }else if(!isNaN(stu)){
    $markAns.textContent='✗'; $markAns.className='marker no';
    $fbAns.innerHTML = `Ans: <span class="ans">${expectedStr} ${currentQ.unitOut}</span>`;
  }

  if(ok){ score++; correctSoFar++; }
  $scoreTop.textContent = `${score} / ${idx+1}`;

  $ansVal.disabled=true;
  $nextBtn.disabled=false;

  if(mode==='target' && correctSoFar>=target){
    finish('Target achieved!');
  }
}

function nextQ(){
  idx++;
  if(idx % QUESTIONS.length === 0){
    QUESTIONS = buildSet(BATCH); // refresh questions for variety
  }
  renderQ();
  updateTop();
}

/* ========= Events ========= */
document.querySelectorAll('input.num').forEach(inp=>{
  inp.addEventListener('blur', ()=>{
    const x = parseNum(inp);
    if(isFinite(x)) inp.value = to2(x);
  });
});
$checkBtn.addEventListener('click', checkCurrent);
$nextBtn.addEventListener('click', nextQ);
$newBtn.addEventListener('click', ()=>{ $startModal.style.display='flex'; });

// Keyboard shortcuts
document.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !$nextBtn.disabled){ nextQ(); }
  else if(e.key==='Enter' && $nextBtn.disabled && !$checkBtn.disabled){ checkCurrent(); }
});

/* ========= Start modal logic ========= */
function updateModeFields(){
  const modeVal = document.querySelector('input[name="mode"]:checked').value;
  el('timedField').style.display = (modeVal==='timed') ? '' : 'none';
  el('targetField').style.display = (modeVal==='target') ? '' : 'none';
}
document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener('change', updateModeFields));

el('startBtn').addEventListener('click', ()=>{
  nameStr = el('nameInput').value.trim() || 'Student';
  mode = document.querySelector('input[name="mode"]:checked').value;
  unlimited = false;
  if(mode==='timed'){
    const tSel = parseInt(document.querySelector('input[name="tlimit"]:checked').value,10);
    unlimited = (tSel===0);
    timeLeft = unlimited ? 0 : (tSel || 1200);
  } else { timeLeft = 0; }
  if(mode==='target'){
    target = clamp(parseInt(el('targetInput').value,10)||8,1,1000000);
  } else { target = 0; }
  $startModal.style.display='none';
  $mode.textContent = mode==='timed' ? 'Timed' : 'Target';
  if(mode==='timed' && unlimited){ $timer.textContent='—'; }
  startWorksheet();
});

el('restartBtn').addEventListener('click', ()=>{ $startModal.style.display='flex'; });
updateModeFields();

/* ========= Fullscreen toggle ========= */
$fsBtn.addEventListener('click', ()=>{
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen?.();
  }else{
    document.exitFullscreen?.();
  }
});
document.addEventListener('fullscreenchange', ()=>{
  $fsBtn.textContent = document.fullscreenElement ? '✕ Exit full screen' : '⛶ Full screen';
});

/* ========= Initial ========= */
$startModal.style.display='flex';
</script>
</body>
</html>
